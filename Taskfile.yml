# Global Taskfile for AI-powered Git automation
# Managed by workbench repo: https://github.com/isaacgarza/workbench
# Installed location: ~/.config/task/Taskfile.yml
# 
# To customize per-project: Create a local Taskfile.yml in your project
# To edit global config: Edit ~/.config/task/taskfile.env

version: "3"

tasks:
  # ============================================================================
  # GIT AUTOMATION
  # ============================================================================
  setup-ai:
    desc: "Setup AI configuration"
    silent: true
    cmds:
      - |
        CONFIG_DIR="$HOME/.config/task"
        ENV_FILE="$CONFIG_DIR/taskfile.env"
        
        mkdir -p "$CONFIG_DIR"
        
        if [ ! -f "$ENV_FILE" ]; then
          echo "# Taskfile AI Configuration" > "$ENV_FILE"
          echo "# Uncomment and configure one of the examples below or add your own" >> "$ENV_FILE"
          echo "" >> "$ENV_FILE"
          echo "# AI_COMMAND=claude -p --agent ci-cd --strict-mcp-config" >> "$ENV_FILE"
          echo "# AI_COMMAND=kiro-cli chat --no-interactive --agent ci-cd" >> "$ENV_FILE"
          echo "# AI_COMMAND=copilot --agent ci-cd -p" >> "$ENV_FILE"
          echo "" >> "$ENV_FILE"
          echo "‚úÖ Created $ENV_FILE"
          echo "üìù Please edit the file to configure your AI command"
        else
          echo "‚ÑπÔ∏è  $ENV_FILE already exists"
          if ! grep -q "AI_COMMAND=claude" "$ENV_FILE"; then
            printf "  Add Claude example to $ENV_FILE? [Y/n] "
            read -r REPLY
            if [[ ! $REPLY =~ ^[Nn]$ ]]; then
              echo "" >> "$ENV_FILE"
              echo "# AI_COMMAND=claude -p --agent ci-cd --strict-mcp-config" >> "$ENV_FILE"
              echo "  ‚úì Added Claude example"
            fi
          fi
        fi

  check-ai:
    internal: true
    silent: true
    cmds:
      - |
        LOCAL_ENV=".taskfile/taskfile.env"
        GLOBAL_ENV="$HOME/.config/task/taskfile.env"
        
        if [ -f "$LOCAL_ENV" ]; then
          ENV_FILE="$LOCAL_ENV"
        elif [ -f "$GLOBAL_ENV" ]; then
          ENV_FILE="$GLOBAL_ENV"
        else
          echo "‚ùå AI not configured"
          echo "   Run task setup-ai"
          exit 1
        fi
        
        if grep -q "^AI_COMMAND=" "$ENV_FILE"; then
          AI_CMD=$(grep "^AI_COMMAND=" "$ENV_FILE" | cut -d'=' -f2- | cut -d' ' -f1)
          if command -v "$AI_CMD" >/dev/null 2>&1; then
            mkdir -p /tmp/task-ai
            grep "^AI_COMMAND=" "$ENV_FILE" | cut -d'=' -f2- > /tmp/task-ai/command
          else
            echo "AI command not found"
            exit 1
          fi
        else
          echo "‚ùå AI_COMMAND not set in $ENV_FILE"
          exit 1
        fi
  commit:
    desc: "ü§ñ Generate AI-powered commit message based on staged changes"
    silent: true
    dir: '{{.USER_WORKING_DIR | default .TASKFILE_DIR}}'
    deps: [check-ai]
    cmds:
      - |
        # Validate staged changes exist
        STAGED_FILES=$(git diff --cached --name-only)
        if [ -z "$STAGED_FILES" ]; then
          echo "‚ùå No staged changes found. Use 'git add' first."
          exit 1
        fi

        echo "ü§ñ Analyzing staged changes with AI..."
        echo ""

        # Prepare diff and file list
        DIFF_CONTENT=$(git diff --cached --no-color)
        FILE_LIST=$(echo "$STAGED_FILES" | tr '\n' ', ' | sed 's/,$//')

        # Determine commit rules (use commitlint if exists, otherwise defaults)
        if [ -f .github/.commitlintrc.json ]; then
          COMMIT_RULES="Follow the rules in this commitlint configuration: $(cat .github/.commitlintrc.json)"
        else
          COMMIT_RULES="Follow these conventional commit rules
            - Header (first line) must be ‚â§72 characters (no exceptions)
            - Use conventional commit format: type(scope): description
            - Types: feat, fix, perf, deps, revert, docs, style, refactor, test, build, ci, chore
            - No period at end of subject
            - Use semicolon (;) to separate multiple changes in header
            - Separate header and body with blank line
            - Body lines must be ‚â§100 characters each
            - Use bullet points for multiple changes in body"
        fi

        # Build AI prompt
        AI_PROMPT="Generate a conventional commit message based on the changes.

        CRITICAL REQUIREMENTS:
        - Header MUST be ‚â§72 characters total (type + scope + colon + space + subject)
        - MUST use format: type(scope): subject
        - Subject must be concise - focus on WHAT changed, not HOW
        - If multiple changes, use semicolon in subject or list in body
        - NEVER omit type or scope
        - Count characters carefully before responding

        $COMMIT_RULES

        Files changed: $FILE_LIST

        Diff:
        $DIFF_CONTENT

        Return only the commit message, nothing else."

        # Get AI command and generate commit message
        AI_COMMAND=$(cat /tmp/task-ai/command)
        COMMIT_MSG=$(echo "$AI_PROMPT" | $AI_COMMAND | tr -d '\033' | sed 's/\[[0-9;]*m//g' | sed 's/^[> ]*//g')

        # Display and commit
        echo "‚ú® AI Analysis Complete"
        echo ""
        echo "üìù Generated commit message:"
        echo "   $COMMIT_MSG"
        echo ""
        echo "üöÄ Committing..."
        git commit -m "$COMMIT_MSG"
        echo "‚úÖ Committed successfully!"

  pr-content:
    desc: "ü§ñ Generate AI-powered PR content (internal helper)"
    internal: true
    silent: true
    dir: '{{.USER_WORKING_DIR | default .TASKFILE_DIR}}'
    deps: [check-ai]
    cmds:
      - |
        BRANCH=$(git branch --show-current)
        if [ "$BRANCH" = "main" ]; then
          echo "‚ùå Cannot create PR from main branch"
          exit 1
        fi

        # Extract issue number from branch name (e.g., feature/ISSUE-123-description)
        ISSUE_NUMBER=$(echo "$BRANCH" | grep -oE '[A-Z]+-[0-9]+' | head -1)

        # If no issue in branch name, prompt for it
        if [ -z "$ISSUE_NUMBER" ]; then
          echo "üîç No issue number found in branch name: $BRANCH"
          echo ""
          read -p "üìã Enter issue number (e.g., ISSUE-123) or press Enter to skip: " USER_ISSUE
          ISSUE_NUMBER="$USER_ISSUE"
        else
          echo "‚úÖ Found issue number: $ISSUE_NUMBER"
        fi

        COMMITS=$(git log --oneline origin/main..HEAD)
        COMMIT_COUNT=$(git rev-list --count origin/main..$BRANCH)
        CHANGED_FILES=$(git diff --name-only origin/main..$BRANCH)

        # Use PR template if exists, otherwise use simple format
        HAS_TEMPLATE=false
        if [ -f .github/pull_request_template.md ]; then
          PR_TEMPLATE=$(cat .github/pull_request_template.md)
          HAS_TEMPLATE=true
        else
          PR_TEMPLATE="## Summary

          ## Changes

          ## Testing"
          # Remove leading whitespace from each line
          PR_TEMPLATE=$(echo "$PR_TEMPLATE" | sed 's/^[[:space:]]*//')
        fi

        AI_PROMPT="Generate a professional PR title and fill out this template based on the changes:

        Template:
        $PR_TEMPLATE

        Branch: $BRANCH
        Issue: ${ISSUE_NUMBER:-None}
        Commits: $COMMIT_COUNT

        Recent commits:
        $COMMITS

        Changed files:
        $CHANGED_FILES

        Return: TITLE: <title>
        DESCRIPTION: <filled template>"

        AI_COMMAND=$(cat /tmp/task-ai/command)

        RAW_RESPONSE=$(echo "$AI_PROMPT" | $AI_COMMAND)
        AI_RESPONSE=$(echo "$RAW_RESPONSE" | sed 's/\x1b\[[0-9;]*[a-zA-Z]//g' | sed 's/\x1b\[[0-9;]*R//g' | tr -d '\033\007\015' | sed 's/^[> ]*//g')

        PR_TITLE=$(echo "$AI_RESPONSE" | grep "^TITLE:" | sed 's/^TITLE: //' | head -1 | tr -d '\n\r')
        PR_DESCRIPTION=$(echo "$AI_RESPONSE" | sed -n '/^DESCRIPTION:/,$ p' | sed '1d' | sed 's/^```markdown$//' | sed 's/^```$//')

        if [ -z "$PR_TITLE" ]; then PR_TITLE="feat: improve codebase"; fi
        if [ -z "$PR_DESCRIPTION" ]; then PR_DESCRIPTION="## Summary\n\nBranch: $BRANCH\nCommits: $COMMIT_COUNT"; fi

        # Only add "Closes" if no PR template and user confirms (GitHub issues only)
        if [ "$HAS_TEMPLATE" = "false" ] && [ -n "$ISSUE_NUMBER" ]; then
          # Check if it's a GitHub issue (numeric with optional #)
          CLEAN_ISSUE=$(echo "$ISSUE_NUMBER" | sed 's/^#//')
          if echo "$CLEAN_ISSUE" | grep -qE '^[0-9]+$'; then
            # It's a GitHub issue
            echo ""
            read -p "‚ùì Close issue #$CLEAN_ISSUE when PR merges? (y/N): " CLOSE_ISSUE
            if [ "$CLOSE_ISSUE" = "y" ] || [ "$CLOSE_ISSUE" = "Y" ]; then
              PR_DESCRIPTION="Closes #$CLEAN_ISSUE\n\n$PR_DESCRIPTION"
            fi
          fi
        fi

        mkdir -p /tmp/task-pr
        echo "$PR_TITLE" > /tmp/task-pr/title
        echo "$PR_DESCRIPTION" > /tmp/task-pr/description

        echo "üìù Title: $PR_TITLE"
        echo "üìÑ Description:"
        echo "$PR_DESCRIPTION"

  create-pr:
    desc: "ü§ñ Create AI-powered pull request with smart title and description"
    silent: true
    dir: '{{.USER_WORKING_DIR | default .TASKFILE_DIR}}'
    cmds:
      - |
        BRANCH=$(git branch --show-current)

        # Check if remote branch exists
        if git ls-remote --heads origin $BRANCH | grep -q $BRANCH; then
          # Remote exists, check for divergence
          git fetch origin $BRANCH --quiet

          LOCAL=$(git rev-parse @)
          REMOTE=$(git rev-parse @{u})
          BASE=$(git merge-base @ @{u})

          if [ "$LOCAL" = "$REMOTE" ]; then
            echo "‚úÖ Branch is up to date with remote"
          elif [ "$LOCAL" = "$BASE" ]; then
            echo "‚ö†Ô∏è  Remote has commits not in local branch"
            echo "‚ùå Cannot create PR - please pull first: git pull"
            exit 1
          elif [ "$REMOTE" = "$BASE" ]; then
            echo "üì§ Local has unpushed commits, pushing..."
            if ! git push origin $BRANCH; then
              echo "‚ùå Push failed"
              exit 1
            fi
          else
            echo "‚ùå Branch has diverged from remote"
            echo "üí° Fix with: git pull --rebase or git reset"
            exit 1
          fi
        else
          # Remote doesn't exist, push it
          echo "üì§ Pushing new branch to remote..."
          if ! git push -u origin $BRANCH; then
            echo "‚ùå Push failed"
            exit 1
          fi
        fi

        echo "ü§ñ Analyzing branch changes with AI: $BRANCH"
      - task: pr-content
      - |
        PR_TITLE=$(cat /tmp/task-pr/title)
        PR_DESCRIPTION=$(cat /tmp/task-pr/description)

        echo "‚ú® AI Analysis Complete"
        echo "üöÄ Creating PR..."

        PR_OUTPUT=$(gh pr create --title "$PR_TITLE" --body "$PR_DESCRIPTION" --assignee @me 2>&1)
        PR_URL=$(echo "$PR_OUTPUT" | grep -o 'https://github.com[^[:space:]]*')

        echo "‚úÖ Pull request created!"
        if [ -n "$PR_URL" ]; then
          echo "üîó $PR_URL"
        else
          echo "$PR_OUTPUT"
        fi

  update-pr:
    desc: "üîÑ Update current PR description with AI-generated content"
    silent: true
    dir: '{{.USER_WORKING_DIR | default .TASKFILE_DIR}}'
    cmds:
      - |
        BRANCH=$(git branch --show-current)
        if [ "$BRANCH" = "main" ]; then
          echo "‚ùå Cannot update PR from main branch"
          exit 1
        fi

        echo "üîç Checking for existing PR..."
        PR_NUMBER=$(gh pr view --json number -q .number 2>/dev/null)

        if [ -z "$PR_NUMBER" ]; then
          echo "‚ùå No PR found for branch: $BRANCH"
          echo "üí° Use 'task create-pr' to create a new PR"
          exit 1
        fi

        echo "ü§ñ Analyzing branch changes with AI: $BRANCH"
      - task: pr-content
      - |
        PR_DESCRIPTION=$(cat /tmp/task-pr/description)
        PR_NUMBER=$(gh pr view --json number -q .number 2>/dev/null)

        echo "‚ú® AI Analysis Complete"
        echo "üîÑ Updating PR #$PR_NUMBER..."

        gh pr edit $PR_NUMBER --body "$PR_DESCRIPTION"

        echo "‚úÖ PR description updated!"
        echo "üîó View: $(gh pr view --json url -q .url)"
  # ============================================================================
  # UTILITY
  # ============================================================================


  help:
    desc: "‚ùì Show this help message"
    silent: true
    cmds:
      - |
        TASKFILE_PATH="${TASKFILE}"
        IS_GLOBAL=false
        
        if [[ "$TASKFILE_PATH" == *".config/task/Taskfile.yml"* ]]; then
          IS_GLOBAL=true
        fi
        
        echo "üõ†Ô∏è  Task Runner"
        echo ""
        
        if [ "$IS_GLOBAL" = true ]; then
          echo "üìç Using global Taskfile"
          echo "   Location: ~/.config/task/Taskfile.yml"
          echo "   Managed by: https://github.com/isaacgarza/workbench"
          echo ""
        fi
        
        echo "ü§ñ AI-Powered Git Automation:"
        echo "   setup-ai       - Setup AI configuration (first-time setup)"
        echo "   commit         - AI-generated commit messages"
        echo "   create-pr      - AI-generated PR (auto-pushes if needed)"
        echo "   update-pr      - Update existing PR description"
        echo ""
        echo "‚ÑπÔ∏è  For detailed task list: task --list"
