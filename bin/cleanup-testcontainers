#!/bin/bash
# Clean up orphaned Testcontainers resources

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Parse arguments
DRY_RUN=false
FORCE=false

while [[ $# -gt 0 ]]; do
  case $1 in
    --dry-run)
      DRY_RUN=true
      shift
      ;;
    --force|-f)
      FORCE=true
      shift
      ;;
    --help|-h)
      echo "Usage: $0 [OPTIONS]"
      echo ""
      echo "Clean up Docker testcontainers, networks, volumes, and images"
      echo ""
      echo "Options:"
      echo "  --dry-run    Show what would be deleted without deleting"
      echo "  --force, -f  Skip confirmation prompt"
      echo "  --help, -h   Show this help message"
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      echo "Use --help for usage information"
      exit 1
      ;;
  esac
done

echo -e "${BLUE}ðŸ§¹ Testcontainers Cleanup${NC}"
echo ""

# Check if Docker is running
if ! docker info >/dev/null 2>&1; then
  echo -e "${RED}âŒ Docker is not running${NC}"
  exit 1
fi

# Find testcontainers
CONTAINERS=$(docker ps -a --filter "label=org.testcontainers=true" -q)
NETWORKS=$(docker network ls --filter "label=org.testcontainers=true" -q)
VOLUMES=$(docker volume ls --filter "label=org.testcontainers=true" -q)
IMAGES=$(docker images --filter "label=org.testcontainers=true" -q)

# Count items
CONTAINER_COUNT=$(echo "$CONTAINERS" | grep -c . || echo 0)
NETWORK_COUNT=$(echo "$NETWORKS" | grep -c . || echo 0)
VOLUME_COUNT=$(echo "$VOLUMES" | grep -c . || echo 0)
IMAGE_COUNT=$(echo "$IMAGES" | grep -c . || echo 0)

echo "Found:"
echo "  â€¢ $CONTAINER_COUNT containers"
echo "  â€¢ $NETWORK_COUNT networks"
echo "  â€¢ $VOLUME_COUNT volumes"
echo "  â€¢ $IMAGE_COUNT dangling images"
echo ""

# Exit if nothing to clean
if [ "$CONTAINER_COUNT" -eq 0 ] && [ "$NETWORK_COUNT" -eq 0 ] && [ "$VOLUME_COUNT" -eq 0 ] && [ "$IMAGE_COUNT" -eq 0 ]; then
  echo -e "${GREEN}âœ… Nothing to clean up${NC}"
  exit 0
fi

# Dry run mode
if [ "$DRY_RUN" = true ]; then
  echo -e "${YELLOW}ðŸ” Dry run mode - showing what would be deleted:${NC}"
  echo ""
  
  if [ "$CONTAINER_COUNT" -gt 0 ]; then
    echo "Containers:"
    docker ps -a --filter "label=org.testcontainers=true" --format "  â€¢ {{.Names}} ({{.Image}})"
  fi
  
  if [ "$NETWORK_COUNT" -gt 0 ]; then
    echo "Networks:"
    docker network ls --filter "label=org.testcontainers=true" --format "  â€¢ {{.Name}}"
  fi
  
  if [ "$VOLUME_COUNT" -gt 0 ]; then
    echo "Volumes:"
    docker volume ls --filter "label=org.testcontainers=true" --format "  â€¢ {{.Name}}"
  fi
  
  exit 0
fi

# Confirmation prompt
if [ "$FORCE" = false ]; then
  echo -e "${YELLOW}âš ï¸  This will permanently delete all testcontainers resources${NC}"
  read -p "Continue? (y/N): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Cancelled"
    exit 0
  fi
fi

# Cleanup
echo "Cleaning up..."
echo ""

if [ "$CONTAINER_COUNT" -gt 0 ]; then
  echo "ðŸ—‘ï¸  Removing containers..."
  echo "$CONTAINERS" | xargs docker rm -f
  echo -e "${GREEN}âœ“ Removed $CONTAINER_COUNT containers${NC}"
fi

if [ "$NETWORK_COUNT" -gt 0 ]; then
  echo "ðŸ—‘ï¸  Removing networks..."
  echo "$NETWORKS" | xargs docker network rm
  echo -e "${GREEN}âœ“ Removed $NETWORK_COUNT networks${NC}"
fi

if [ "$VOLUME_COUNT" -gt 0 ]; then
  echo "ðŸ—‘ï¸  Removing volumes..."
  echo "$VOLUMES" | xargs docker volume rm
  echo -e "${GREEN}âœ“ Removed $VOLUME_COUNT volumes${NC}"
fi

if [ "$IMAGE_COUNT" -gt 0 ]; then
  echo "ðŸ—‘ï¸  Pruning dangling images..."
  docker image prune -f --filter "label=org.testcontainers=true" >/dev/null
  echo -e "${GREEN}âœ“ Pruned $IMAGE_COUNT images${NC}"
fi

echo ""
echo -e "${GREEN}âœ… Testcontainers cleanup complete${NC}"
