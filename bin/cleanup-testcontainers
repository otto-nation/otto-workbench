#!/bin/bash
# Clean up orphaned Testcontainers resources

set -e

_SELF="$(readlink "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")"
. "$(dirname "$_SELF")/../lib/ui.sh"

# Parse arguments
DRY_RUN=false
FORCE=false

while [[ $# -gt 0 ]]; do
  case $1 in
    --dry-run)
      DRY_RUN=true
      shift
      ;;
    --force|-f)
      FORCE=true
      shift
      ;;
    --help|-h)
      echo "Usage: $(basename "$0") [OPTIONS]"
      echo ""
      echo "Clean up Docker testcontainers, networks, volumes, and images"
      echo ""
      echo "Options:"
      echo "  --dry-run    Show what would be deleted without deleting"
      echo "  --force, -f  Skip confirmation prompt"
      echo "  --help, -h   Show this help message"
      exit 0
      ;;
    *)
      err "Unknown option: $1"
      echo "Use --help for usage information" >&2
      exit 1
      ;;
  esac
done

echo -e "${BOLD}${BLUE}Testcontainers Cleanup${NC}\n"

# Check if Docker is running
if ! docker info >/dev/null 2>&1; then
  err "Docker is not running"
  exit 1
fi

# Find testcontainers
CONTAINERS=$(docker ps -a --filter "label=org.testcontainers=true" -q)
NETWORKS=$(docker network ls --filter "label=org.testcontainers=true" -q)
VOLUMES=$(docker volume ls --filter "label=org.testcontainers=true" -q)
IMAGES=$(docker images --filter "label=org.testcontainers=true" -q)

# Count items
CONTAINER_COUNT=$(echo "$CONTAINERS" | grep -c . || echo 0)
NETWORK_COUNT=$(echo "$NETWORKS" | grep -c . || echo 0)
VOLUME_COUNT=$(echo "$VOLUMES" | grep -c . || echo 0)
IMAGE_COUNT=$(echo "$IMAGES" | grep -c . || echo 0)

echo "Found:"
echo "  • $CONTAINER_COUNT containers"
echo "  • $NETWORK_COUNT networks"
echo "  • $VOLUME_COUNT volumes"
echo "  • $IMAGE_COUNT dangling images"
echo ""

# Exit if nothing to clean
if [ "$CONTAINER_COUNT" -eq 0 ] && [ "$NETWORK_COUNT" -eq 0 ] && [ "$VOLUME_COUNT" -eq 0 ] && [ "$IMAGE_COUNT" -eq 0 ]; then
  success "Nothing to clean up"
  exit 0
fi

# Dry run mode
if [ "$DRY_RUN" = true ]; then
  warn "Dry run mode — showing what would be deleted:"
  echo ""

  if [ "$CONTAINER_COUNT" -gt 0 ]; then
    echo "Containers:"
    docker ps -a --filter "label=org.testcontainers=true" --format "  • {{.Names}} ({{.Image}})"
  fi

  if [ "$NETWORK_COUNT" -gt 0 ]; then
    echo "Networks:"
    docker network ls --filter "label=org.testcontainers=true" --format "  • {{.Name}}"
  fi

  if [ "$VOLUME_COUNT" -gt 0 ]; then
    echo "Volumes:"
    docker volume ls --filter "label=org.testcontainers=true" --format "  • {{.Name}}"
  fi

  exit 0
fi

# Confirmation prompt
if [ "$FORCE" = false ]; then
  warn "This will permanently delete all testcontainers resources"
  if ! confirm_n "Continue?"; then
    echo "Cancelled"
    exit 0
  fi
fi

# Cleanup
info "Cleaning up..."
echo ""

if [ "$CONTAINER_COUNT" -gt 0 ]; then
  info "Removing $CONTAINER_COUNT containers..."
  echo "$CONTAINERS" | xargs docker rm -f
  success "Removed $CONTAINER_COUNT containers"
fi

if [ "$NETWORK_COUNT" -gt 0 ]; then
  info "Removing $NETWORK_COUNT networks..."
  echo "$NETWORKS" | xargs docker network rm
  success "Removed $NETWORK_COUNT networks"
fi

if [ "$VOLUME_COUNT" -gt 0 ]; then
  info "Removing $VOLUME_COUNT volumes..."
  echo "$VOLUMES" | xargs docker volume rm
  success "Removed $VOLUME_COUNT volumes"
fi

if [ "$IMAGE_COUNT" -gt 0 ]; then
  info "Pruning $IMAGE_COUNT dangling images..."
  docker image prune -f --filter "label=org.testcontainers=true" >/dev/null
  success "Pruned $IMAGE_COUNT images"
fi

echo ""
success "Testcontainers cleanup complete"
