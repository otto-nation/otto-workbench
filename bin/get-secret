#!/bin/bash
# Get secret from AWS Secrets Manager

set -e

_SELF="$(readlink "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")"
. "$(dirname "$_SELF")/../lib/ui.sh"

# Parse arguments
if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
  echo "Usage: $(basename "$0") [OPTIONS]"
  echo ""
  echo "Interactively retrieve a secret from AWS Secrets Manager"
  echo ""
  echo "Options:"
  echo "  --help, -h   Show this help message"
  echo ""
  echo "Environment:"
  echo "  AWS_REGION   AWS region (default: us-east-1)"
  echo "  AWS_PROFILE  AWS profile to use"
  exit 0
fi

# Check for AWS CLI
if ! command -v aws >/dev/null 2>&1; then
  err "AWS CLI not found. Install it: https://aws.amazon.com/cli/"
  exit 1
fi

REGION="${AWS_REGION:-us-east-1}"
PROFILE_ARG=""
if [ -n "${AWS_PROFILE:-}" ]; then
  PROFILE_ARG="--profile $AWS_PROFILE"
fi

info "Fetching secrets from region: $REGION"
echo ""

# Get list of secret names
SECRETS=$(aws secretsmanager list-secrets \
  --region "$REGION" \
  $PROFILE_ARG \
  --query 'SecretList[*].Name' \
  --output text)

if [ -z "$SECRETS" ]; then
  err "No secrets found in region $REGION"
  exit 1
fi

# Convert to array
SECRET_ARRAY=($SECRETS)

# Display numbered list
echo "Available secrets:"
echo ""
for i in "${!SECRET_ARRAY[@]}"; do
  echo "  $((i+1)). ${SECRET_ARRAY[$i]}"
done
echo ""

# Prompt for selection
read -p "Select a secret (1-${#SECRET_ARRAY[@]}): " SELECTION

# Validate input
if ! [[ "$SELECTION" =~ ^[0-9]+$ ]] || [ "$SELECTION" -lt 1 ] || [ "$SELECTION" -gt "${#SECRET_ARRAY[@]}" ]; then
  err "Invalid selection"
  exit 1
fi

SECRET_NAME="${SECRET_ARRAY[$((SELECTION-1))]}"

echo ""
info "Retrieving secret: $SECRET_NAME"
echo ""

# Get and display secret value
aws secretsmanager get-secret-value \
  --secret-id "$SECRET_NAME" \
  --region "$REGION" \
  $PROFILE_ARG \
  --query SecretString \
  --output text
