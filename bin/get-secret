#!/bin/bash
# Get secret from AWS Secrets Manager

# Get AWS region (default to us-east-1)
REGION="${AWS_REGION:-us-east-1}"

# Get AWS profile if specified
PROFILE_ARG=""
if [ -n "$AWS_PROFILE" ]; then
    PROFILE_ARG="--profile $AWS_PROFILE"
fi

echo "Fetching secrets from region: $REGION"
echo ""

# Get list of secret names
SECRETS=$(aws secretsmanager list-secrets \
    --region "$REGION" \
    $PROFILE_ARG \
    --query 'SecretList[*].Name' \
    --output text)

if [ -z "$SECRETS" ]; then
    echo "No secrets found in region $REGION"
    exit 1
fi

# Convert to array
SECRET_ARRAY=($SECRETS)

# Display numbered list
echo "Available secrets:"
echo ""
for i in "${!SECRET_ARRAY[@]}"; do
    echo "$((i+1)). ${SECRET_ARRAY[$i]}"
done
echo ""

# Prompt for selection
read -p "Select a secret (1-${#SECRET_ARRAY[@]}): " SELECTION

# Validate input
if ! [[ "$SELECTION" =~ ^[0-9]+$ ]] || [ "$SELECTION" -lt 1 ] || [ "$SELECTION" -gt "${#SECRET_ARRAY[@]}" ]; then
    echo "Invalid selection"
    exit 1
fi

# Get selected secret name
SECRET_NAME="${SECRET_ARRAY[$((SELECTION-1))]}"

echo ""
echo "Retrieving secret: $SECRET_NAME"
echo ""

# Get and display secret value
aws secretsmanager get-secret-value \
    --secret-id "$SECRET_NAME" \
    --region "$REGION" \
    $PROFILE_ARG \
    --query SecretString \
    --output text
