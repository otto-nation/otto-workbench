#!/bin/bash
# Analyze memory usage and generate report

set -e

# Enable echo -e interpretation
shopt -s xpg_echo 2>/dev/null || true

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

echo -e "${BOLD}${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BOLD}${BLUE}â•‘     Memory Analysis Report             â•‘${NC}"
echo -e "${BOLD}${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo "Generated: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

# System Overview
echo -e "${BOLD}${BLUE}â”â”â” System Information â”â”â”${NC}"
system_profiler SPHardwareDataType | grep -E "Model Name|Memory:" | sed 's/^[ ]*/  /'
echo ""

# Memory Pressure Status
echo -e "${BOLD}${BLUE}â”â”â” Memory Pressure Status â”â”â”${NC}"
mem_pressure_status=$(memory_pressure 2>&1 | grep "System-wide memory" || echo "normal")
if echo "$mem_pressure_status" | grep -qi "critical"; then
    echo -e "  ${RED}ğŸ”´ CRITICAL${NC} - System under severe memory pressure"
elif echo "$mem_pressure_status" | grep -qi "warn"; then
    echo -e "  ${YELLOW}ğŸŸ¡ WARNING${NC} - System under memory pressure"
else
    echo -e "  ${GREEN}ğŸŸ¢ NORMAL${NC} - Memory pressure is healthy"
fi
echo ""

# Memory Statistics
echo -e "${BOLD}${BLUE}â”â”â” Memory Statistics â”â”â”${NC}"
page_size=$(vm_stat | grep "page size" | awk '{print $8}')
vm_stat | perl -ne '/Pages\s+([^:]+)[^\d]+(\d+)/ and printf("  %-25s %10.2f MB\n", "$1:", $2 * '$page_size' / 1048576);'
echo ""

# Swap Usage
echo -e "${BOLD}${BLUE}â”â”â” Swap Usage â”â”â”${NC}"
swap_info=$(sysctl vm.swapusage | sed 's/vm.swapusage: //')
echo "  $swap_info"
swap_used=$(echo "$swap_info" | grep -oE 'used = [0-9.]+' | awk '{print $3}')
swap_total=$(echo "$swap_info" | grep -oE 'total = [0-9.]+' | awk '{print $3}')
swap_used_gb=$(echo "scale=1; $swap_used / 1024" | bc)
if (( $(echo "$swap_used > 10240" | bc -l) )); then
    echo -e "  ${RED}âš ï¸  High swap usage: ${swap_used_gb}GB used${NC}"
fi
echo ""

# Top Memory Consumers
echo -e "${BOLD}${BLUE}â”â”â” Top 10 Memory Consuming Processes â”â”â”${NC}"
printf "  ${BOLD}%-8s %6s %10s  %-50s${NC}\n" "PID" "%MEM" "MEMORY" "APPLICATION"
ps aux | sort -nrk 4 | head -11 | tail -10 | while read user pid cpu mem vsz rss tt stat started time cmd; do
    full_cmd="$cmd"
    for arg in "$@"; do full_cmd="$full_cmd $arg"; done
    
    if echo "$full_cmd" | grep -q "IntelliJ IDEA"; then
        app="IntelliJ IDEA"
        proj=$(echo "$full_cmd" | grep -oE '/[^/]+/(build|subprojects|\.idea)' | head -1 | cut -d'/' -f2)
        [ -n "$proj" ] && app="$app ($proj)"
    elif echo "$full_cmd" | grep -q "\.app/Contents"; then
        app=$(echo "$full_cmd" | grep -oE '/[^/]+\.app' | head -1 | sed 's|.*/||' | sed 's|\.app||')
    elif echo "$full_cmd" | grep -qi "java.*gradle"; then
        app="Gradle/Java"
        proj=$(echo "$full_cmd" | grep -oE '/[^/]+/(build|subprojects)' | head -1 | cut -d'/' -f2)
        [ -n "$proj" ] && app="$app ($proj)"
    elif echo "$full_cmd" | grep -q "Virtualization"; then
        app="macOS VM"
    else
        app=$(basename "$cmd")
    fi
    
    [ ${#app} -gt 50 ] && app="${app:0:47}..."
    mem_mb=$(echo "scale=0; $rss/1024" | bc)
    printf "  %-8s %6s %10s MB  %-50s\n" "$pid" "$mem" "$mem_mb" "$app"
done
echo ""

# Memory Hogs (>500MB)
echo -e "${BOLD}${BLUE}â”â”â” Processes Using >500MB â”â”â”${NC}"
printf "  ${BOLD}%12s %8s  %-60s${NC}\n" "MEMORY" "%MEM" "APPLICATION"
ps aux | awk 'NR>1 && $6 > 500000' | while read user pid cpu mem vsz rss tt stat started time cmd; do
    full_cmd="$cmd"
    for arg in "$@"; do full_cmd="$full_cmd $arg"; done
    
    if echo "$full_cmd" | grep -q "IntelliJ IDEA"; then
        app="IntelliJ IDEA"
        proj=$(echo "$full_cmd" | grep -oE '/[^/]+/(build|subprojects|\.idea)' | head -1 | cut -d'/' -f2)
        [ -n "$proj" ] && app="$app ($proj)"
    elif echo "$full_cmd" | grep -q "\.app/Contents"; then
        app=$(echo "$full_cmd" | grep -oE '/[^/]+\.app' | head -1 | sed 's|.*/||' | sed 's|\.app||')
    elif echo "$full_cmd" | grep -qi "java.*gradle"; then
        app="Gradle/Java"
        proj=$(echo "$full_cmd" | grep -oE '/[^/]+/(build|subprojects)' | head -1 | cut -d'/' -f2)
        [ -n "$proj" ] && app="$app ($proj)"
    elif echo "$full_cmd" | grep -q "Virtualization"; then
        app="macOS VM"
    else
        app=$(basename "$cmd")
    fi
    
    [ ${#app} -gt 60 ] && app="${app:0:57}..."
    mem_mb=$(echo "scale=2; $rss/1024" | bc)
    printf "  %10.2f MB  %6s%%  %-60s\n" "$mem_mb" "$mem" "$app"
done | sort -nrk 1
[ -z "$(ps aux | awk 'NR>1 && $6 > 500000')" ] && echo "  None found"
echo ""

# Memory by User
echo -e "${BOLD}${BLUE}â”â”â” Memory Usage by User â”â”â”${NC}"
printf "  ${BOLD}%-20s %12s${NC}\n" "USER" "TOTAL MEMORY"
ps aux | awk '{user[$1]+=$6} END {for (u in user) printf "  %-20s %10.2f MB\n", u, user[u]/1024}' | sort -nrk 2 | head -5
echo ""

# Summary & Recommendations
echo -e "${BOLD}${BLUE}â”â”â” Summary & Recommendations â”â”â”${NC}"
total_mem=$(sysctl hw.memsize | awk '{print $2/1073741824}')
free_mem=$(vm_stat | grep "Pages free" | awk '{print $3}' | tr -d '.')
free_mb=$((free_mem * page_size / 1048576))

echo "  Total RAM: ${total_mem} GB"
echo "  Free Memory: ${free_mb} MB"
echo ""

if echo "$mem_pressure_status" | grep -qi "critical"; then
    echo -e "  ${RED}${BOLD}âš ï¸  CRITICAL - Immediate Action Required:${NC}"
    echo "    â€¢ Close unnecessary applications immediately"
    echo "    â€¢ Kill memory-intensive processes"
    echo "    â€¢ Restart your system"
    echo "    â€¢ Consider upgrading RAM"
elif echo "$mem_pressure_status" | grep -qi "warn"; then
    echo -e "  ${YELLOW}${BOLD}âš ï¸  WARNING - Action Recommended:${NC}"
    echo "    â€¢ Close unused browser tabs"
    echo "    â€¢ Quit background applications"
    echo "    â€¢ Run: sudo purge (to clear caches)"
    echo "    â€¢ Stop unused Gradle/Java processes"
elif (( $(echo "$swap_used > 10240" | bc -l) )); then
    echo -e "  ${YELLOW}${BOLD}âš ï¸  High Swap Usage Detected:${NC}"
    echo "    â€¢ System is using disk instead of RAM (slow)"
    echo "    â€¢ Close memory-intensive applications"
    echo "    â€¢ Restart to clear swap"
else
    echo -e "  ${GREEN}${BOLD}âœ“ System Memory is Healthy${NC}"
fi

echo ""
echo -e "${BOLD}${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
