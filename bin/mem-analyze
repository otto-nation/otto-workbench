#!/bin/bash
# Analyze memory usage and generate report

set -e

_SELF="$(readlink "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")"
. "$(dirname "$_SELF")/../lib/ui.sh"

echo -e "${BOLD}${BLUE}Memory Analysis Report${NC}"
echo -e "${DIM}Generated: $(date '+%Y-%m-%d %H:%M:%S')${NC}"
echo ""

# System Overview
echo -e "${BOLD}${BLUE}━━━ System Information ━━━${NC}"
system_profiler SPHardwareDataType | grep -E "Model Name|Memory:" | sed 's/^[ ]*/  /'
echo ""

# Memory Pressure Status
echo -e "${BOLD}${BLUE}━━━ Memory Pressure Status ━━━${NC}"
# memory_pressure is macOS-only; stderr redirect catches systems where it is unavailable,
# and the fallback to "normal" prevents the pressure-based recommendations from triggering
mem_pressure_status=$(memory_pressure 2>&1 | grep "System-wide memory" || echo "normal")
if echo "$mem_pressure_status" | grep -qi "critical"; then
  echo -e "  ${RED}${BOLD}CRITICAL${NC} — System under severe memory pressure"
elif echo "$mem_pressure_status" | grep -qi "warn"; then
  echo -e "  ${YELLOW}${BOLD}WARNING${NC} — System under memory pressure"
else
  echo -e "  ${GREEN}${BOLD}NORMAL${NC} — Memory pressure is healthy"
fi
echo ""

# Memory Statistics
echo -e "${BOLD}${BLUE}━━━ Memory Statistics ━━━${NC}"
# Captured before the pipeline so the value can be shell-interpolated into the perl script below
# and reused in the summary section — variables set inside pipelines are lost to the parent shell
page_size=$(vm_stat | grep "page size" | awk '{print $8}')
# Regex extracts page type name and count; multiplies by page_size (shell-interpolated) to get MB
vm_stat | perl -ne '/Pages\s+([^:]+)[^\d]+(\d+)/ and printf("  %-25s %10.2f MB\n", "$1:", $2 * '$page_size' / 1048576);'
echo ""

# Swap Usage
echo -e "${BOLD}${BLUE}━━━ Swap Usage ━━━${NC}"
swap_info=$(sysctl vm.swapusage | sed 's/vm.swapusage: //')
echo "  $swap_info"
swap_used=$(echo "$swap_info" | grep -oE 'used = [0-9.]+' | awk '{print $3}')
swap_used_gb=$(echo "scale=1; $swap_used / 1024" | bc)
if (( $(echo "$swap_used > 10240" | bc -l) )); then
  warn "High swap usage: ${swap_used_gb}GB used"
fi
echo ""

# Top Memory Consumers
echo -e "${BOLD}${BLUE}━━━ Top 10 Memory Consuming Processes ━━━${NC}"
printf "  ${BOLD}%-8s %6s %10s  %-50s${NC}\n" "PID" "%MEM" "MEMORY" "APPLICATION"
ps aux | sort -nrk 4 | head -11 | tail -10 | while read -r user pid cpu mem vsz rss tt stat started time cmd; do
  full_cmd="$cmd"
  for arg in "$@"; do full_cmd="$full_cmd $arg"; done

  # Match known app patterns for a readable name; fall back to the binary basename
  if echo "$full_cmd" | grep -q "IntelliJ IDEA"; then
    app="IntelliJ IDEA"
    proj=$(echo "$full_cmd" | grep -oE '/[^/]+/(build|subprojects|\.idea)' | head -1 | cut -d'/' -f2)
    [ -n "$proj" ] && app="$app ($proj)"
  elif echo "$full_cmd" | grep -q "\.app/Contents"; then
    app=$(echo "$full_cmd" | grep -oE '/[^/]+\.app' | head -1 | sed 's|.*/||' | sed 's|\.app||')
  elif echo "$full_cmd" | grep -qi "java.*gradle"; then
    app="Gradle/Java"
    proj=$(echo "$full_cmd" | grep -oE '/[^/]+/(build|subprojects)' | head -1 | cut -d'/' -f2)
    [ -n "$proj" ] && app="$app ($proj)"
  elif echo "$full_cmd" | grep -q "Virtualization"; then
    app="macOS VM"
  else
    app=$(basename "$cmd")
  fi

  [ ${#app} -gt 50 ] && app="${app:0:47}..."
  mem_mb=$(echo "scale=0; $rss/1024" | bc)
  printf "  %-8s %6s %10s MB  %-50s\n" "$pid" "$mem" "$mem_mb" "$app"
done
echo ""

# Memory Hogs (>500MB)
echo -e "${BOLD}${BLUE}━━━ Processes Using >500MB ━━━${NC}"
printf "  ${BOLD}%12s %8s  %-60s${NC}\n" "MEMORY" "%MEM" "APPLICATION"
# shellcheck disable=SC2034  # user,cpu,vsz,tt,stat,started,time unused — read to consume positional fields
ps aux | awk 'NR>1 && $6 > 500000' | while read -r user pid cpu mem vsz rss tt stat started time cmd; do
  full_cmd="$cmd"
  for arg in "$@"; do full_cmd="$full_cmd $arg"; done

  if echo "$full_cmd" | grep -q "IntelliJ IDEA"; then
    app="IntelliJ IDEA"
    proj=$(echo "$full_cmd" | grep -oE '/[^/]+/(build|subprojects|\.idea)' | head -1 | cut -d'/' -f2)
    [ -n "$proj" ] && app="$app ($proj)"
  elif echo "$full_cmd" | grep -q "\.app/Contents"; then
    app=$(echo "$full_cmd" | grep -oE '/[^/]+\.app' | head -1 | sed 's|.*/||' | sed 's|\.app||')
  elif echo "$full_cmd" | grep -qi "java.*gradle"; then
    app="Gradle/Java"
    proj=$(echo "$full_cmd" | grep -oE '/[^/]+/(build|subprojects)' | head -1 | cut -d'/' -f2)
    [ -n "$proj" ] && app="$app ($proj)"
  elif echo "$full_cmd" | grep -q "Virtualization"; then
    app="macOS VM"
  else
    app=$(basename "$cmd")
  fi

  [ ${#app} -gt 60 ] && app="${app:0:57}..."
  mem_mb=$(echo "scale=2; $rss/1024" | bc)
  printf "  %10.2f MB  %6s%%  %-60s\n" "$mem_mb" "$mem" "$app"
done | sort -nrk 1
[ -z "$(ps aux | awk 'NR>1 && $6 > 500000')" ] && echo "  None found"
echo ""

# Memory by User
echo -e "${BOLD}${BLUE}━━━ Memory Usage by User ━━━${NC}"
printf "  ${BOLD}%-20s %12s${NC}\n" "USER" "TOTAL MEMORY"
ps aux | awk '{user[$1]+=$6} END {for (u in user) printf "  %-20s %10.2f MB\n", u, user[u]/1024}' | sort -nrk 2 | head -5
echo ""

# Summary & Recommendations
echo -e "${BOLD}${BLUE}━━━ Summary & Recommendations ━━━${NC}"
total_mem=$(sysctl hw.memsize | awk '{print $2/1073741824}')
free_mem=$(vm_stat | grep "Pages free" | awk '{print $3}' | tr -d '.')
free_mb=$((free_mem * page_size / 1048576))

echo "  Total RAM: ${total_mem} GB"
echo "  Free Memory: ${free_mb} MB"
echo ""

if echo "$mem_pressure_status" | grep -qi "critical"; then
  echo -e "  ${RED}${BOLD}CRITICAL — Immediate Action Required:${NC}"
  echo "    • Close unnecessary applications immediately"
  echo "    • Kill memory-intensive processes"
  echo "    • Restart your system"
  echo "    • Consider upgrading RAM"
elif echo "$mem_pressure_status" | grep -qi "warn"; then
  echo -e "  ${YELLOW}${BOLD}WARNING — Action Recommended:${NC}"
  echo "    • Close unused browser tabs"
  echo "    • Quit background applications"
  echo "    • Run: sudo purge (to clear caches)"
  echo "    • Stop unused Gradle/Java processes"
elif (( $(echo "$swap_used > 10240" | bc -l) )); then
  echo -e "  ${YELLOW}${BOLD}High Swap Usage Detected:${NC}"
  echo "    • System is using disk instead of RAM (slow)"
  echo "    • Close memory-intensive applications"
  echo "    • Restart to clear swap"
else
  success "System Memory is Healthy"
fi

echo ""
echo -e "${BOLD}${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
